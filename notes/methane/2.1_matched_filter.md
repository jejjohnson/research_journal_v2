---
title: Matched Filter
subject: Methane
short_title: Matched Filter
authors:
  - name: J. Emmanuel Johnson
    affiliations:
      - UN
    orcid: 0000-0002-6739-0053
    email: juan.johnson@un.org
license: CC-BY-4.0
keywords: methane
---



---
## Derivation

We start with the Beer-Lambert law which relates the intensity of light to the properties of the material through which the light is traveling.
The equation is commonly written as:


```{math}
:label: beer-lamberts-law
L(\lambda) = L_0(\lambda) \exp \left(-\alpha \cdot \boldsymbol{\nu}(\lambda)\right)
```

where:
* $L(\lambda)$ is the at sensor radiance with CH$_4$ absorption
* $L_0(\lambda)$ is the at sensor radiance without any CH$_4$ absorption (background radiance)
* $\alpha$ is the CH$_4$ concentration-path length [ppm-m]
* $\boldsymbol{\nu}(\lambda)$ is the path-integrated unit absorption coefficient, which depends on the wavelength and the atmospheric conditions [dimensionless]



If we assume that there is a small absorption, i.e., $\alpha \cdot s<< 1$, then we can do a first-order Taylor expansion of the exponential term to make this function simpler.
We use the relationship that for small $x$, then $\exp(-x) \approx 1 - x$.
If we apply this to the Beer-Lambert's law, we get:

$$
L(\lambda) \approx L_0(\lambda) - \alpha \cdot \boldsymbol{\nu}(\lambda) \cdot L_0(\lambda)
$$

We can re-define some of the terms to make this equation more interpretable.
Firstly, let's rearrange this equation to redefine is as the radiance due to the change in CH$_4$ concentration.

$$
\Delta L(\lambda) = L(\lambda) - L_0(\lambda) \approx - \alpha \cdot \boldsymbol{\nu}(\lambda) \cdot L_0(\lambda)
$$

Next, we notice that the $L_0(\lambda)$ is unknown.
However, we can assume that we can approximate this with the background mean

$$
L_0(\lambda) \approx \mu(\lambda) \hspace{5mm} [W m^{-2} sr^{-1} nm^{-1}]But,
$$

Therefore, we can write the radiance due to the CH$_4$ enhancement term as

$$
\Delta L(\lambda) \approx - \alpha \cdot \boldsymbol{\nu}(\lambda) \cdot \mu(\lambda)
$$

and likewise the optical depth term as

$$
\tau(\lambda) = \alpha \cdot \boldsymbol{\nu}(\lambda)
$$

Finally, let's define the target spectrum as

$$
t(\lambda) = - \boldsymbol{\nu}(\lambda) \cdot \mu(\lambda) \hspace{5mm} [W m^{-2} sr^{-1} nm^{-1}][ppm \cdot m]^{-1}
$$

which finally gives us the linear relationship

$$
\Delta L(\lambda) \approx \alpha \cdot t(\lambda)
$$

So, going back to the original measurement model, we can plug in our new definitions to get

$$
L(\lambda) \approx \mu(\lambda) + \alpha \cdot t(\lambda) 
$$

We can assume that we never actually observe the true radiance, $L(\lambda)$, even with this simplified linear model.
So, let's add in the measurement model to include the noise, we get:

$$
\begin{aligned}
L(\lambda) &= \mu(\lambda) + \alpha \cdot t(\lambda) \\
y(\lambda) &= L(\lambda) + \epsilon(\lambda) \\
\end{aligned}
$$

where $\epsilon(\lambda)$ is the instrument noise, surface reflectance variability, and atmospheric effects.
This is a statistical linear model with a bias term (background mean) and additive noise.

In great Bayesian fashion, we can write the joint distribution of our variables and parameters

$$
p(y,L,\lambda,\theta) = p(y|L,\lambda,\theta)p(L|\lambda,\theta)p(\theta)
$$

where:
* $y$ is the observed spectrum
* $L$ is the true spectrum
* $\lambda$ is the wavelength
* $\boldsymbol{\theta}$ are the parameters of the linear model, i.e., mean, covariance, and coefficient

This problem becomes a lot easier to solve as we simply the problem to a linear Gaussian model.
We can write the likelihood function as

$$
\log p(\theta | \mathcal{D}, \lambda) = 
\sum_{n=1}^{N} \log \mathcal{N}\left(y_n(\lambda) | \mu(\lambda) + \alpha \cdot t(\lambda), \Sigma\right)
+ \log p(\theta)
$$

This log-likelihood term can be explicity written as

$$
\log p(\alpha | \mathcal{D}, \boldsymbol{\theta}) =
\sum_{n=1}^{N} ||y_n(\lambda) - \mu(\lambda) - \alpha \cdot t(\lambda)||^2_{\Sigma^{-1}} + \text{const}
$$

We can calculate the derivative of this log-likelihood term with respect to $\alpha$ and set it to zero to get a closed-form solution for the maximum likelihood estimate of $\alpha$.

$$
\partial_\alpha \log p(\alpha | \mathcal{D}, \boldsymbol{\theta}) = 
2 t(\lambda)^T \Sigma^{-1}
\left[y(\lambda) - \mu(\lambda) - \alpha \cdot t(\lambda)\right] = 0
$$

Rearranging this equation gives us the maximum likelihood estimate of $\alpha$.

$$
\hat{\alpha} =
\frac{t(\lambda)^T \Sigma^{-1} \left[y(\lambda) - \mu(\lambda)\right]}
{t(\lambda)^T \Sigma^{-1} t(\lambda)}
$$

So, solving for $\hat{\alpha}$, will give us access to the enhancement concentration, $\Delta \text{CH}_4 = \hat{\alpha} \cdot t(\lambda)$.


---
## Approximations

### Background Mean and Covariance

Let's define the mean background mean and covariance spectrum.
We need to assume that these can be calculated from the observations, $\mathcal{D}=\left\{y_n\right\}_{n=1}^{N}$.

$$
\begin{aligned}
\text{Background Mean}: && \mu_y(\lambda) &= \mathbb{E}[Y] = \frac{1}{N} \sum_{i=n}^{N} y_n(\lambda) \\
\text{Background Cov}: && \Sigma_y(\lambda,\lambda') &= 
\text{Cov}[Y,Y'] =  
\frac{1}{N-1} \sum_{n=1}^{N} 
\left[y_n(\lambda) - \mu(\lambda)\right]
\left[y_n(\lambda') - \mu(\lambda')\right]^T
\end{aligned}
$$

This means that the only unknown parameter is the concentration enhancement, $\alpha$.

---
### RTM


$$
\begin{aligned}
\text{RTM Model}: && \boldsymbol{\nu}:=\boldsymbol{\nu}(\lambda, \text{AMF}) &= \boldsymbol{f}(\lambda,\text{AMF}, \boldsymbol{\theta}) + \epsilon
\end{aligned}
$$

$$
t = - A \cdot AMF(\theta) \cdot \mu(\lambda)
$$


---
### Covariance Decomposition

$$
\Sigma= U\Lambda V^\top
$$

So the inverse will be

$$
\Sigma^{-1} = V \Lambda^{-1} U^\top
$$

If we wish to use the regularized covariance matrix, we can use the decomposition

$$
\left(\Sigma + \lambda I\right)^{-1} = V \left(\Lambda + \lambda I\right)^{-1} U^\top
$$


---
### Covariance Regularization

We can use a shrinkage estimator to regularize the covariance matrix.

$$
\Sigma_{\text{reg}} = (1 - \gamma) \Sigma + \gamma \frac{\text{trace}(\Sigma)}{d} I
$$

---
### Logarithmic Matched Filter


Beginning with Beer-Lambert's law [](#beer-lamberts-law), we can take the natural logarithm of both sides to get

$$
\log L(\lambda) = \log L_0(\lambda) - \alpha \cdot \boldsymbol{\nu}(\lambda)
$$

We can extract the optical depth term as

$$
\begin{aligned}
\tau(\lambda) &= - \alpha \cdot \boldsymbol{\nu}(\lambda) \\
    &= -\log L(\lambda) + \log L_0(\lambda) \\
    &= -\log \frac{L(\lambda)}{L_0(\lambda)} \\
    &= \log \frac{L_0(\lambda)}{L(\lambda)}
\end{aligned}
$$

The key inversion problem still remains the same, as the $L_0(\lambda)$ is still unknown for each pixel.

#### Strategy 1: Approximate Optical Depth

We could approximate the background mean again as $L_0(\lambda) \approx \mu(\lambda)$.
This would give us the optical depth as

$$
\tau(\lambda) \approx \log \left[\frac{\mu_\lambda}{L_\lambda}\right]
$$

#### Strategy 2: Log-Radiance Space

When we have a small perturbation in the radiance, we can use a first-order Taylor expansion to approximate the logarithm of the radiance.
So, assuming we have the radiances plus a small perturbation, i.e., 

$$
L_\lambda \approx \mu_\lambda + \Delta L_\lambda
$$

where where $\Delta L_\lambda << \mu_\lambda$.

Firstly, we should

$$
\begin{aligned}
\tau(\lambda) 
    &\approx \log \left[\frac{\mu_\lambda}{\mu_\lambda + \Delta L_\lambda}\right] \\
    &\approx \log \left[\frac{1}{1+ \Delta L_\lambda/\mu_\lambda}\right] \\
    &\approx - \log \left[1+ \frac{\Delta L_\lambda}{\mu_\lambda}\right]
\end{aligned}
$$

Using the Taylor expansion for small $x$, $\log(1+x) \approx x$ for $|x| << 1$, we can approximate the optical depth as

$$
\tau_\lambda \approx - \frac{\Delta L_\lambda}{\mu_\lambda} 
$$

So, substituting the optical depth term $\tau_\lambda = \alpha \cdot t_\lambda$ into this equation, we get

$$
\alpha \cdot t_\lambda \approx - \frac{\Delta L_\lambda}{\mu_\lambda}
$$

which yields 

$$
\Delta L_\lambda \approx - \alpha \cdot t_\lambda \cdot \mu_\lambda
$$

This yields the exact same approach as the linear matched filter, except that the target spectrum is nowNow,



---
## Code Design


* Pre-train RTM model to learn $\boldsymbol{f}(\lambda,\text{AMF}, \boldsymbol{\theta})$
* Calculate background mean and covariance from data
* Calculate concentration enhancement, $\alpha$, using closed-form solution (Matched Filter)



### Matched Filter

```python
# initialize obs data and target spectrum
data: Array["Samples Wavelength"] = ...  # Load your spectral data here
target_spectrum: XArray["Wavelength"] = ...  # Load or define your target spectrum here


# define the RTM model
params: PyTree = ...  # Load or define your RTM model parameters here
rtm_model: Callable[[data, target_spectrum], inferred_conc] = load_rtm_model(params)
```